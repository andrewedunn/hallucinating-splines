---
// ABOUTME: Displays a collapsible table of recent city actions with client-side pagination.
// ABOUTME: Collapsed by default; expands to show paginated action history.
interface Action {
  id: number;
  game_year: number;
  action_type: string;
  params: Record<string, any>;
  result: string;
  cost: number;
  created_at: string;
}
interface Props {
  actions: Action[];
  total: number;
}
const { actions, total } = Astro.props;

const ACTION_LABELS: Record<string, string> = {
  zone_residential: 'Zone Residential',
  zone_commercial: 'Zone Commercial',
  zone_industrial: 'Zone Industrial',
  build_road: 'Build Road',
  build_rail: 'Build Rail',
  build_power_line: 'Build Power Line',
  build_park: 'Build Park',
  build_fire_station: 'Build Fire Station',
  build_police_station: 'Build Police Station',
  build_coal_power: 'Build Coal Power',
  build_nuclear_power: 'Build Nuclear Power',
  build_seaport: 'Build Seaport',
  build_airport: 'Build Airport',
  build_stadium: 'Build Stadium',
  bulldoze: 'Bulldoze',
  advance: 'Advance',
  set_budget: 'Set Budget',
  llama_fund: 'MYSTERIOUS BENEFACTOR',
  llama_olpc: 'EDUCATION WINDFALL',
  disaster_earthquake: 'EARTHQUAKE ROCKS CITY',
  disaster_tornado: 'TORNADO ALERT',
  disaster_fire: 'INFERNO ENGULFS DISTRICT',
  disaster_flood: 'FLOODING DEVASTATES LOWLANDS',
  disaster_monster: 'MONSTER ATTACKS!',
  disaster_meltdown: 'NUCLEAR MELTDOWN',
};

function formatDetail(a: Action): string {
  const p = a.params || {};
  if (p.headline) {
    if (p.url) return `${p.headline} â€” <a href="${p.url}" target="_blank" rel="noopener">${p.url}</a>`;
    return p.headline;
  }
  if (a.action_type === 'advance') {
    return `${p.months || 1} month${(p.months || 1) > 1 ? 's' : ''}`;
  }
  if (a.action_type === 'set_budget') {
    const parts: string[] = [];
    if (p.tax_rate !== undefined) parts.push(`tax ${p.tax_rate}%`);
    if (p.fire_percent !== undefined) parts.push(`fire ${p.fire_percent}%`);
    if (p.police_percent !== undefined) parts.push(`police ${p.police_percent}%`);
    if (p.road_percent !== undefined) parts.push(`road ${p.road_percent}%`);
    return parts.join(', ') || '-';
  }
  if (typeof p.x === 'number' && typeof p.y === 'number') {
    return `(${p.x}, ${p.y})`;
  }
  return '-';
}
---
<div class="action-log">
  <button class="log-toggle" id="action-log-toggle" aria-expanded="false">
    <span class="log-title">Action Log <span class="log-count" id="action-total">({total})</span></span>
    <span class="toggle-icon" id="toggle-icon">&#9654;</span>
  </button>
  <div class="log-content" id="action-log-content" hidden>
    {actions.length === 0 ? (
      <p class="empty">No actions yet.</p>
    ) : (
      <div class="log-table-wrap">
        <table class="log-table">
          <thead>
            <tr>
              <th>Year</th>
              <th>Action</th>
              <th>Detail</th>
              <th>Cost</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody id="action-log-body">
            {actions.map((a) => (
              <tr class="action-row" data-action-id={a.id}>
                <td class="year">{a.game_year}</td>
                <td>{ACTION_LABELS[a.action_type] || a.action_type}</td>
                <td class="detail" set:html={formatDetail(a)}></td>
                <td class="cost">{a.cost > 0 ? `$${a.cost.toLocaleString()}` : '-'}</td>
                <td><span class={`badge ${a.result}`}>{a.result}</span></td>
              </tr>
            ))}
          </tbody>
        </table>
        {actions.length > 10 && (
          <div class="pagination" id="action-log-pagination"></div>
        )}
      </div>
    )}
  </div>
</div>

<script>
  const ROWS_PER_PAGE = 10;
  const toggle = document.getElementById('action-log-toggle')!;
  const content = document.getElementById('action-log-content')!;
  const icon = document.getElementById('toggle-icon')!;
  const rows = Array.from(document.querySelectorAll('#action-log-body .action-row')) as HTMLElement[];
  const paginationEl = document.getElementById('action-log-pagination');
  let currentPage = 0;
  const totalPages = Math.ceil(rows.length / ROWS_PER_PAGE);

  function showPage(page: number) {
    currentPage = page;
    const start = page * ROWS_PER_PAGE;
    const end = start + ROWS_PER_PAGE;
    rows.forEach((row, i) => {
      row.style.display = (i >= start && i < end) ? '' : 'none';
    });
    renderPagination();
  }

  function renderPagination() {
    if (!paginationEl || totalPages <= 1) return;
    paginationEl.innerHTML = '';

    const addBtn = (label: string, page: number, disabled = false, active = false) => {
      const btn = document.createElement('button');
      btn.textContent = label;
      btn.className = 'page-btn' + (active ? ' active' : '') + (disabled ? ' disabled' : '');
      if (!disabled && !active) {
        btn.addEventListener('click', () => {
          (window as any).umami?.track('action-log-page');
          showPage(page);
        });
      }
      paginationEl!.appendChild(btn);
    };

    addBtn('\u2039', currentPage - 1, currentPage === 0);

    // Show at most 7 page numbers with ellipsis
    const maxVisible = 7;
    let start = 0, end = totalPages - 1;
    if (totalPages > maxVisible) {
      start = Math.max(0, currentPage - 3);
      end = start + maxVisible - 1;
      if (end >= totalPages) {
        end = totalPages - 1;
        start = end - maxVisible + 1;
      }
    }

    if (start > 0) {
      addBtn('1', 0);
      if (start > 1) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '\u2026';
        paginationEl!.appendChild(ellipsis);
      }
    }

    for (let i = start; i <= end; i++) {
      addBtn(String(i + 1), i, false, i === currentPage);
    }

    if (end < totalPages - 1) {
      if (end < totalPages - 2) {
        const ellipsis = document.createElement('span');
        ellipsis.className = 'page-ellipsis';
        ellipsis.textContent = '\u2026';
        paginationEl!.appendChild(ellipsis);
      }
      addBtn(String(totalPages), totalPages - 1);
    }

    addBtn('\u203A', currentPage + 1, currentPage === totalPages - 1);
  }

  toggle.addEventListener('click', () => {
    const expanded = content.hidden;
    content.hidden = !expanded;
    toggle.setAttribute('aria-expanded', String(expanded));
    icon.style.transform = expanded ? 'rotate(90deg)' : '';
    if (expanded) {
      (window as any).umami?.track('action-log-toggle');
      if (rows.length > ROWS_PER_PAGE) {
        showPage(0);
      }
    }
  });

  // Hide rows beyond first page on initial load
  if (rows.length > ROWS_PER_PAGE) {
    rows.forEach((row, i) => {
      if (i >= ROWS_PER_PAGE) row.style.display = 'none';
    });
  }
</script>

<style>
.action-log { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-top: 1.5rem; overflow: hidden; }
.log-toggle { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0.875rem 1.25rem; background: none; border: none; color: var(--text); cursor: pointer; font: inherit; text-align: left; }
.log-toggle:hover { background: var(--border); }
.log-title { font-size: 0.875rem; font-weight: 600; }
.log-count { color: var(--text-muted); font-weight: 400; }
.toggle-icon { font-size: 0.75rem; color: var(--text-muted); transition: transform 0.2s; display: inline-block; }
.log-content { padding: 0 1.25rem 1.25rem; }
.empty { color: var(--text-muted); font-size: 0.875rem; }
.log-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.log-table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
.log-table th { text-align: left; color: var(--text-muted); font-weight: 500; padding: 0.375rem 0.5rem; border-bottom: 1px solid var(--border); white-space: nowrap; }
.log-table td { padding: 0.375rem 0.5rem; border-bottom: 1px solid var(--border); }
.log-table .year { color: var(--text-muted); }
.log-table .detail { color: var(--text-muted); font-family: monospace; font-size: 0.75rem; }
.log-table .cost { text-align: right; white-space: nowrap; }
.badge { font-size: 0.6875rem; padding: 0.1rem 0.4rem; border-radius: 9999px; }
.badge.success { background: #166534; color: #86efac; }
.badge.failed { background: #7f1d1d; color: #fca5a5; }
.pagination { display: flex; gap: 0.375rem; justify-content: center; align-items: center; margin-top: 0.75rem; flex-wrap: wrap; }
.page-btn { background: var(--border); border: none; color: var(--text-muted); min-width: 2rem; height: 2rem; padding: 0 0.5rem; border-radius: 6px; cursor: pointer; font-size: 0.8125rem; display: inline-flex; align-items: center; justify-content: center; transition: background 0.15s, color 0.15s; }
.page-btn.active { background: var(--accent); color: white; cursor: default; }
.page-btn.disabled { opacity: 0.35; cursor: default; }
.page-btn:hover:not(.active):not(.disabled) { background: var(--text-muted); color: var(--bg); }
.page-ellipsis { color: var(--text-muted); font-size: 0.8125rem; padding: 0 0.125rem; }
</style>
