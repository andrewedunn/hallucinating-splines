---
// ABOUTME: Displays full city statistics â€” population, budget, census, evaluation, infrastructure.
// ABOUTME: Accepts a FullCityStats object from the API.
interface Props {
  stats: {
    population: number;
    funds: number;
    year: number;
    month: number;
    score: number;
    classification: string;
    isPowered: boolean;
    demand: { residential: number; commercial: number; industrial: number };
    census: {
      resPop: number; comPop: number; indPop: number;
      roadTotal: number; railTotal: number;
      poweredZoneCount: number; unpoweredZoneCount: number;
      policeStationPop: number; fireStationPop: number;
      coalPowerPop: number; nuclearPowerPop: number;
      seaportPop: number; airportPop: number; stadiumPop: number;
      crimeAverage: number; pollutionAverage: number; landValueAverage: number;
    };
    evaluation: {
      approval?: number;
      populationDelta?: number;
      assessedValue?: number;
      scoreDelta?: number;
      problems: string[];
    };
    budget: {
      taxRate: number; cashFlow: number;
      roadPercent: number; firePercent: number; policePercent: number;
      roadEffect: number; fireEffect: number; policeEffect: number;
      roadMaintenanceBudget: number; fireMaintenanceBudget: number; policeMaintenanceBudget: number;
    };
  };
}
const { stats } = Astro.props;
const { demand, census, evaluation, budget } = stats;

function demandPct(val: number): number {
  return Math.max(0, Math.min(100, (val / 2000) * 50 + 50));
}

const totalZones = census.poweredZoneCount + census.unpoweredZoneCount;
const powerPct = totalZones > 0 ? Math.round((census.poweredZoneCount / totalZones) * 100) : 0;

const problemColors: Record<string, string> = {
  crime: '#c04040', pollution: '#a855f7', housing: '#d89030',
  taxes: '#e8d040', traffic: '#506090', unemployment: '#4080c0', fire: '#c04040',
};
---
<div class="stats-panel">
  <div class="stat-row">
    <span class="label">Population</span>
    <span class="value" data-live="population">{stats.population.toLocaleString()}</span>
  </div>
  <div class="stat-row">
    <span class="label">Funds</span>
    <span class="value" data-live="funds">${stats.funds.toLocaleString()}</span>
  </div>
  <div class="stat-row">
    <span class="label">Year</span>
    <span class="value" data-live="year">{stats.year}</span>
  </div>
  <div class="stat-row">
    <span class="label">Score</span>
    <span class="value" data-live="score">{stats.score}</span>
  </div>
  <div class="stat-row">
    <span class="label">Class</span>
    <span class="value" data-live="classification">{stats.classification}</span>
  </div>

  <h3 class="section-title">Approval</h3>
  <div class="approval-bar">
    <div class="bar-track">
      <div class="bar-fill approval" data-live-bar="approval" style={`width: ${evaluation.approval ?? 0}%`}></div>
    </div>
    <span class="approval-pct" data-live="approval">{evaluation.approval ?? 0}%</span>
  </div>

  <h3 class="section-title">Demand</h3>
  <div class="demand-bars">
    <div class="demand-bar">
      <span class="demand-label">R</span>
      <div class="bar-track"><div class="bar-fill res" data-live-bar="residential" style={`width: ${demandPct(demand.residential)}%`}></div></div>
    </div>
    <div class="demand-bar">
      <span class="demand-label">C</span>
      <div class="bar-track"><div class="bar-fill com" data-live-bar="commercial" style={`width: ${demandPct(demand.commercial)}%`}></div></div>
    </div>
    <div class="demand-bar">
      <span class="demand-label">I</span>
      <div class="bar-track"><div class="bar-fill ind" data-live-bar="industrial" style={`width: ${demandPct(demand.industrial)}%`}></div></div>
    </div>
  </div>

  <h3 class="section-title">Population Breakdown</h3>
  <div class="stat-row sub">
    <span class="label">Residential</span>
    <span class="value" data-live="resPop">{census.resPop.toLocaleString()}</span>
  </div>
  <div class="stat-row sub">
    <span class="label">Commercial</span>
    <span class="value" data-live="comPop">{census.comPop.toLocaleString()}</span>
  </div>
  <div class="stat-row sub">
    <span class="label">Industrial</span>
    <span class="value" data-live="indPop">{census.indPop.toLocaleString()}</span>
  </div>

  <h3 class="section-title">Assessed Value</h3>
  <div class="stat-row sub">
    <span class="label">Value</span>
    <span class="value" data-live="assessedValue">${(evaluation.assessedValue ?? 0).toLocaleString()}</span>
  </div>

  <h3 class="section-title" data-live-problems-title style={evaluation.problems.length === 0 ? 'display:none' : ''}>Top Problems</h3>
  <div class="problem-tags" data-live="problems" style={evaluation.problems.length === 0 ? 'display:none' : ''}>
    {evaluation.problems.map((p) => (
      <span class="problem-tag" style={`background: ${problemColors[p] || '#506090'}22; color: ${problemColors[p] || '#506090'}; border: 1px solid ${problemColors[p] || '#506090'}44`}>{p}</span>
    ))}
  </div>

  <h3 class="section-title">Infrastructure</h3>
  <div class="infra-grid">
    <div class="infra-item">
      <span class="infra-count" data-live="policeStationPop">{census.policeStationPop}</span>
      <span class="infra-label">Police</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="fireStationPop">{census.fireStationPop}</span>
      <span class="infra-label">Fire</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="powerPlants">{census.coalPowerPop + census.nuclearPowerPop}</span>
      <span class="infra-label">Power</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="seaportPop">{census.seaportPop}</span>
      <span class="infra-label">Ports</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="airportPop">{census.airportPop}</span>
      <span class="infra-label">Airports</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="stadiumPop">{census.stadiumPop}</span>
      <span class="infra-label">Stadiums</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="roadTotal">{census.roadTotal}</span>
      <span class="infra-label">Roads</span>
    </div>
    <div class="infra-item">
      <span class="infra-count" data-live="railTotal">{census.railTotal}</span>
      <span class="infra-label">Rail</span>
    </div>
  </div>

  <h3 class="section-title">Power</h3>
  <div class="stat-row sub">
    <span class="label">Powered / Total</span>
    <span class="value" data-live="power">{census.poweredZoneCount} / {totalZones} ({powerPct}%)</span>
  </div>

  <h3 class="section-title">Budget</h3>
  <div class="stat-row sub">
    <span class="label">Tax Rate</span>
    <span class="value" data-live="taxRate">{budget.taxRate}%</span>
  </div>
  <div class="stat-row sub">
    <span class="label">Cash Flow</span>
    <span class={`value ${budget.cashFlow >= 0 ? 'positive' : 'negative'}`} data-live="cashFlow">${budget.cashFlow.toLocaleString()}</span>
  </div>
  <div class="budget-services">
    <div class="budget-service">
      <span class="label">Fire</span>
      <span class="value" data-live="firePercent">{budget.firePercent}%</span>
    </div>
    <div class="budget-service">
      <span class="label">Police</span>
      <span class="value" data-live="policePercent">{budget.policePercent}%</span>
    </div>
    <div class="budget-service">
      <span class="label">Road</span>
      <span class="value" data-live="roadPercent">{budget.roadPercent}%</span>
    </div>
  </div>

  <h3 class="section-title">Environment</h3>
  <div class="stat-row sub">
    <span class="label">Crime</span>
    <span class="value" data-live="crimeAverage">{census.crimeAverage}</span>
  </div>
  <div class="stat-row sub">
    <span class="label">Pollution</span>
    <span class="value" data-live="pollutionAverage">{census.pollutionAverage}</span>
  </div>
  <div class="stat-row sub">
    <span class="label">Land Value</span>
    <span class="value" data-live="landValueAverage">{census.landValueAverage}</span>
  </div>
</div>

<style>
.stats-panel {
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 3px;
  padding: 1.25rem;
  box-shadow: 3px 3px 0 var(--shadow);
}
.stat-row { display: flex; justify-content: space-between; padding: 0.3rem 0; }
.stat-row.sub { padding: 0.2rem 0; font-size: 0.85rem; }
.label { color: var(--text-muted); }
.value { font-weight: 600; }
.value.positive { color: var(--green-light); }
.value.negative { color: var(--red); }
.section-title {
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  font-family: var(--pixel-font);
  font-size: 0.45rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
}
.approval-bar { display: flex; align-items: center; gap: 0.5rem; }
.approval-bar .bar-track { flex: 1; }
.approval-pct { font-weight: 600; font-size: 0.875rem; min-width: 3rem; text-align: right; }
.bar-fill.approval { background: var(--green); }
.demand-bar { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.3rem; }
.demand-label { width: 1rem; font-family: var(--pixel-font); font-size: 0.5rem; font-weight: 600; }
.bar-track { flex: 1; height: 8px; background: var(--bg); border: 1px solid var(--border); border-radius: 2px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
.bar-fill.res { background: var(--green); }
.bar-fill.com { background: var(--blue); }
.bar-fill.ind { background: var(--yellow); }
.problem-tags { display: flex; flex-wrap: wrap; gap: 0.375rem; }
.problem-tag { font-family: var(--pixel-font); font-size: 0.4rem; padding: 0.2rem 0.5rem; border-radius: 2px; text-transform: capitalize; }
.infra-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
.infra-item { text-align: center; background: var(--bg); border: 1px solid var(--border); border-radius: 2px; padding: 0.4rem 0.25rem; }
.infra-count { display: block; font-weight: 700; font-size: 1rem; }
.infra-label { font-family: var(--pixel-font); font-size: 0.35rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.budget-services { display: flex; gap: 1rem; margin-top: 0.25rem; }
.budget-service { display: flex; flex-direction: column; align-items: center; flex: 1; font-size: 0.875rem; background: var(--bg); border: 1px solid var(--border); border-radius: 2px; padding: 0.4rem; }
.budget-service .label { font-family: var(--pixel-font); font-size: 0.35rem; text-transform: uppercase; }
@media (max-width: 480px) {
  .infra-grid { grid-template-columns: repeat(4, 1fr); gap: 0.375rem; }
  .infra-count { font-size: 0.875rem; }
}
</style>
