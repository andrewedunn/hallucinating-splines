---
// ABOUTME: Card component displaying a city thumbnail, name, mayor, population, and activity time.
// ABOUTME: Links to the city detail page. Mayor name links to mayor profile.
interface Props {
  id: string;
  name: string;
  slug?: string;
  mayor: string;
  mayor_id?: string;
  mayor_slug?: string;
  population: number;
  game_year: number;
  score: number;
  status: string;
  updated_at?: string;
  llama?: boolean;
}
const { id, name, slug, mayor, mayor_id, mayor_slug, population, game_year, score, status, updated_at, llama } = Astro.props;
const API_BASE = import.meta.env.PUBLIC_API_URL || 'https://api.hallucinatingsplines.com';

function relativeTime(dateStr?: string): string {
  if (!dateStr) return 'unknown';
  const now = Date.now();
  const then = new Date(dateStr + 'Z').getTime();
  const diffMs = now - then;
  const mins = Math.floor(diffMs / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}d ago`;
  const months = Math.floor(days / 30);
  return `${months}mo ago`;
}

function activityColor(dateStr?: string): string {
  if (!dateStr) return 'stale';
  const diffMs = Date.now() - new Date(dateStr + 'Z').getTime();
  const hours = diffMs / 3600000;
  if (hours < 1) return 'fresh';
  if (hours < 24) return 'recent';
  if (hours < 168) return 'aging';
  return 'stale';
}

const timeAgo = relativeTime(updated_at);
const freshness = activityColor(updated_at);
const cityHref = slug ? `/cities/${slug}` : `/cities/${id}`;
const mayorHref = mayor_slug ? `/mayors/${mayor_slug}` : mayor_id ? `/mayors/${mayor_id}` : null;
---
<div class="city-card" data-city-id={id}>
  <a href={cityHref} class="card-thumb" data-city-id={id} data-api-base={API_BASE} data-game-year={game_year} data-umami-event="city-card-click">
  </a>
  <div class="card-body">
    <div class="card-header">
      <a href={cityHref} class="city-name">{name}{llama ? ' \u{1F999}' : ''}</a>
      <span class={`activity ${freshness}`}>{timeAgo}</span>
    </div>
    {mayorHref ? (
      <a href={mayorHref} class="card-mayor">{mayor}</a>
    ) : (
      <span class="card-mayor">{mayor}</span>
    )}
    <div class="card-stats">
      <div class="stat">
        <span class="stat-label">Pop</span>
        <span class="stat-value" data-stat="population">{population.toLocaleString()}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Year</span>
        <span class="stat-value" data-stat="game_year">{game_year}</span>
      </div>
      <div class="stat">
        <span class="stat-label">Score</span>
        <span class="stat-value" data-stat="score">{score}</span>
      </div>
    </div>
  </div>
</div>

<style>
.city-card {
  display: block;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 3px;
  overflow: hidden;
  color: var(--text);
  transition: border-color 0.2s;
  box-shadow: 3px 3px 0 var(--shadow);
}
.city-card:hover { border-color: var(--accent); }
.card-thumb {
  display: block;
  width: 100%;
  aspect-ratio: 6 / 5;
  background: var(--bg);
  border-bottom: 2px solid var(--border);
}
.card-body { padding: 0.75rem 1rem; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
.city-name { font-family: var(--system); font-size: 0.95rem; font-weight: 700; color: var(--text); line-height: 1.4; }
.city-name:hover { color: var(--accent-hover); }
.activity {
  font-family: var(--system);
  font-size: 0.7rem;
  font-weight: 600;
  padding: 0.15rem 0.5rem;
  border-radius: 2px;
  white-space: nowrap;
}
.activity.fresh { background: var(--green); color: #fff; }
.activity.recent { background: var(--blue-dark); color: var(--panel-light); }
.activity.aging { background: var(--orange); color: #fff; }
.activity.stale { background: var(--border); color: var(--text-muted); }
.card-mayor { display: block; color: var(--text-muted); font-size: 0.8rem; margin-bottom: 0.5rem; }
a.card-mayor:hover { color: var(--accent-hover); }
.card-stats {
  display: flex;
  gap: 1rem;
  padding-top: 0.5rem;
  border-top: 1px solid var(--border);
}
.stat { display: flex; flex-direction: column; }
.stat-label {
  font-family: var(--system);
  font-size: 0.65rem;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
  margin-bottom: 0.15rem;
}
.stat-value { font-weight: 700; font-size: 0.95rem; transition: color 0.4s; }
.stat-value.changed { color: var(--accent-hover); }
@media (max-width: 480px) {
  .card-body { padding: 0.625rem 0.75rem; }
  .card-mayor { margin-bottom: 0.375rem; }
  .city-name { font-size: 0.85rem; }
}
</style>
