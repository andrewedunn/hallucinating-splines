---
// ABOUTME: Card component displaying a city thumbnail, name, mayor, population, and activity time.
// ABOUTME: Links to the city detail page. Mayor name links to mayor profile.
interface Props {
  id: string;
  name: string;
  mayor: string;
  mayor_id?: string;
  population: number;
  game_year: number;
  score: number;
  status: string;
  updated_at?: string;
}
const { id, name, mayor, mayor_id, population, game_year, score, status, updated_at } = Astro.props;
const API_BASE = import.meta.env.PUBLIC_API_URL || 'https://api.hallucinatingsplines.com';

function relativeTime(dateStr?: string): string {
  if (!dateStr) return 'unknown';
  const now = Date.now();
  const then = new Date(dateStr + 'Z').getTime();
  const diffMs = now - then;
  const mins = Math.floor(diffMs / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  const days = Math.floor(hours / 24);
  if (days < 30) return `${days}d ago`;
  const months = Math.floor(days / 30);
  return `${months}mo ago`;
}

function activityColor(dateStr?: string): string {
  if (!dateStr) return 'stale';
  const diffMs = Date.now() - new Date(dateStr + 'Z').getTime();
  const hours = diffMs / 3600000;
  if (hours < 1) return 'fresh';
  if (hours < 24) return 'recent';
  if (hours < 168) return 'aging';
  return 'stale';
}

const timeAgo = relativeTime(updated_at);
const freshness = activityColor(updated_at);
---
<div class="city-card">
  <a href={`/cities/${id}`} class="card-thumb" data-city-id={id} data-api-base={API_BASE}>
  </a>
  <div class="card-body">
    <div class="card-header">
      <a href={`/cities/${id}`} class="city-name">{name}</a>
      <span class={`activity ${freshness}`}>{timeAgo}</span>
    </div>
    {mayor_id ? (
      <a href={`/mayors/${mayor_id}`} class="card-mayor">{mayor}</a>
    ) : (
      <span class="card-mayor">{mayor}</span>
    )}
    <div class="card-stats">
      <div class="stat">
        <span class="stat-value">{population.toLocaleString()}</span>
        <span class="stat-label">pop</span>
      </div>
      <div class="stat">
        <span class="stat-value">{game_year}</span>
        <span class="stat-label">year</span>
      </div>
      <div class="stat">
        <span class="stat-value">{score}</span>
        <span class="stat-label">score</span>
      </div>
    </div>
  </div>
</div>

<style>
.city-card {
  display: block;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  color: var(--text);
  transition: border-color 0.2s;
}
.city-card:hover { border-color: var(--accent); }
.card-thumb {
  display: block;
  width: 100%;
  aspect-ratio: 6 / 5;
  background: var(--border);
}
.card-body { padding: 1rem; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem; }
.city-name { font-weight: 600; font-size: 1.1rem; color: var(--text); }
.city-name:hover { color: var(--accent); }
.activity { font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 9999px; white-space: nowrap; }
.activity.fresh { background: #166534; color: #86efac; }
.activity.recent { background: #1e3a5f; color: #93c5fd; }
.activity.aging { background: #78350f; color: #fde68a; }
.activity.stale { background: var(--border); color: var(--text-muted); }
.card-mayor { display: block; color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.75rem; }
a.card-mayor:hover { color: var(--accent); }
.card-stats { display: flex; gap: 1.5rem; }
.stat { display: flex; flex-direction: column; }
.stat-value { font-weight: 600; font-size: 1rem; }
.stat-label { color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; }
</style>
