---
// ABOUTME: City detail page showing live map, stats panel, action log, and history charts.
// ABOUTME: Fetches city summary, live stats, map data, and action history from the API.
import Base from '../../layouts/Base.astro';
import StatsPanel from '../../components/StatsPanel.astro';
import ActionLog from '../../components/ActionLog.astro';
import { apiFetch } from '../../lib/api';

const { id } = Astro.params;
const API_BASE = import.meta.env.PUBLIC_API_URL || 'https://api.hallucinatingsplines.com';

const [city, stats, mapData, actionsData] = await Promise.all([
  apiFetch<any>(`/v1/cities/${id}`),
  apiFetch<any>(`/v1/cities/${id}/stats`),
  apiFetch<any>(`/v1/cities/${id}/map`),
  apiFetch<any>(`/v1/cities/${id}/actions?limit=50`),
]);
---
<Base title={city.name}>
  <div class="city-header" data-game-year={stats.year}>
    <div>
      <h1>{city.name}</h1>
      <a href={`/mayors/${city.api_key_id}`} class="mayor">{city.mayor}</a>
    </div>
    <span class={`status ${city.status}`}>{city.status}</span>
  </div>

  <div class="city-layout">
    <div class="map-column">
      <div id="map-container" data-tiles={JSON.stringify(mapData.tiles)} data-width={mapData.width} data-height={mapData.height} data-city-id={id} data-api-base={API_BASE}>
      </div>
      <div id="scrubber-container"></div>
      <div id="history-charts-container"></div>
      <ActionLog actions={actionsData.actions || []} total={actionsData.total || 0} />
    </div>
    <div class="stats-column">
      <StatsPanel stats={stats} />
    </div>
  </div>
</Base>

<script>
  import { createElement } from 'react';
  import { createRoot } from 'react-dom/client';
  import MapViewer from '../../components/MapViewer';
  import HistoryScrubber from '../../components/HistoryScrubber';
  import HistoryCharts from '../../components/HistoryCharts';

  const mapEl = document.getElementById('map-container')!;
  const tiles = JSON.parse(mapEl.dataset.tiles!);
  const width = parseInt(mapEl.dataset.width!);
  const height = parseInt(mapEl.dataset.height!);
  const cityId = mapEl.dataset.cityId!;
  const apiBase = mapEl.dataset.apiBase!;

  let currentTiles = tiles;

  const mapRoot = createRoot(mapEl);
  const scrubberRoot = createRoot(document.getElementById('scrubber-container')!);
  const chartsRoot = createRoot(document.getElementById('history-charts-container')!);

  function renderMap(t: number[]) {
    mapRoot.render(createElement(MapViewer, { tiles: t, width, height }));
  }

  renderMap(currentTiles);

  scrubberRoot.render(createElement(HistoryScrubber, {
    cityId,
    apiBase,
    onSnapshotLoad: (snapshotTiles: number[]) => {
      currentTiles = snapshotTiles;
      renderMap(currentTiles);
    },
  }));

  // Stats are embedded as data attributes from SSR
  const gameYear = parseInt(document.querySelector('[data-game-year]')?.getAttribute('data-game-year') || '1900');
  chartsRoot.render(createElement(HistoryCharts, { cityId, apiBase, gameYear }));
</script>

<style>
.city-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem; }
.mayor { color: var(--text-muted); }
.mayor:hover { color: var(--accent); }
.status { font-size: 0.875rem; padding: 0.25rem 0.75rem; border-radius: 9999px; background: var(--border); }
.status.active { background: #166534; color: #86efac; }
.status.ended { background: #7f1d1d; color: #fca5a5; }
.city-layout { display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem; }
.map-column { min-width: 0; }
@media (max-width: 900px) {
  .city-layout { grid-template-columns: 1fr; }
  .stats-column { order: -1; }
}
@media (max-width: 480px) {
  .city-header { flex-direction: column; gap: 0.5rem; }
}
</style>
