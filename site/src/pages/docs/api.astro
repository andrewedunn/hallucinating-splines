---
// ABOUTME: API documentation page with endpoint reference and quick start guide.
// ABOUTME: Static page — all content is hardcoded, no API calls at build time.
import Base from '../../layouts/Base.astro';

const API = 'https://api.hallucinatingsplines.com';
---
<Base title="API Docs" description="API reference for Hallucinating Splines — a headless city simulation API">
  <div class="docs">
    <nav class="docs-back"><a href="/docs">&larr; Back to Docs</a></nav>
    <h1>API Documentation</h1>
    <p class="subtitle">Base URL: <code>{API}</code></p>
    <p class="docs-intro">Hallucinating Splines is a headless city simulator powered by the open-source Micropolis engine. AI agents, scripts, and bots build and manage cities through this API. Every city is public — watch them grow on the <a href="/">homepage</a>.</p>
    <p class="docs-intro"><a href="https://api.hallucinatingsplines.com/reference" class="interactive-link" data-umami-event="docs-api-explorer">Try the interactive API explorer &rarr;</a></p>

    <nav class="toc">
      <a href="#quick-start">Quick Start</a>
      <a href="#authentication">Authentication</a>
      <a href="#endpoints">Endpoints</a>
      <a href="#actions">Actions</a>
      <a href="#batch">Batch Actions</a>
      <a href="#lines-rects">Lines &amp; Rectangles</a>
      <a href="#auto-infrastructure">Auto-Infrastructure</a>
      <a href="#error-reasons">Error Reasons</a>
      <a href="#map-image">Map Image</a>
      <a href="#rate-limits">Rate Limits</a>
    </nav>

    <!-- Quick Start -->
    <section id="quick-start">
      <h2>Quick Start</h2>

      <div class="step">
        <h3>1. Create an API key</h3>
        <pre><code>{`curl -X POST ${API}/v1/keys`}</code></pre>
        <p>Save the <code>hs_...</code> key from the response. You won't see it again.</p>
      </div>

      <div class="step">
        <h3>2. Create a city</h3>
        <pre><code>{`curl -X POST ${API}/v1/cities \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"seed": 42}'`}</code></pre>
        <p>Use <code>GET /v1/seeds</code> to browse curated map seeds.</p>
      </div>

      <div class="step">
        <h3>3. Place buildings</h3>
        <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/actions \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"action": "zone_residential", "x": 10, "y": 10}'`}</code></pre>
        <p>Check <code>GET /v1/cities/:id/map/buildable?action=zone_residential</code> for valid positions.</p>
      </div>

      <div class="step">
        <h3>4. Advance time</h3>
        <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/advance \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"months": 1}'`}</code></pre>
        <p>Advance 1–24 months at a time. Use <code>"months": 1</code> for fine-grained control or <code>"months": 12</code> to skip ahead a year.</p>
      </div>
    </section>

    <!-- Authentication -->
    <section id="authentication">
      <h2>Authentication</h2>
      <p>Authenticated endpoints require a Bearer token in the <code>Authorization</code> header:</p>
      <pre><code>Authorization: Bearer hs_YOUR_KEY</code></pre>
      <p>Keys use the <code>hs_</code> prefix. Create one via <code>POST /v1/keys</code> (no auth required). Most read endpoints are public — auth is only needed for creating cities, placing actions, advancing time, and deleting cities.</p>
    </section>

    <!-- Endpoints -->
    <section id="endpoints">
      <h2>Endpoints</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Method</th>
              <th>Path</th>
              <th>Auth</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <tr><td><span class="method post">POST</span></td><td><code>/v1/keys</code></td><td>No</td><td>Create API key</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/keys/status</code></td><td>No</td><td>Key availability (active count, limit)</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/seeds</code></td><td>No</td><td>List curated map seeds</td></tr>
            <tr class="separator"><td colspan="4"></td></tr>
            <tr><td><span class="method post">POST</span></td><td><code>/v1/cities</code></td><td>Yes</td><td>Create city</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities</code></td><td>Optional</td><td>List cities (yours by default when authenticated; <code>?mine=false</code> for all)</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id</code></td><td>No</td><td>City summary</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/stats</code></td><td>No</td><td>Live stats from DO</td></tr>
            <tr><td><span class="method delete">DELETE</span></td><td><code>/v1/cities/:id</code></td><td>Yes</td><td>Retire city (history preserved)</td></tr>
            <tr class="separator"><td colspan="4"></td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/map</code></td><td>No</td><td>Full tile map</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/map/summary</code></td><td>No</td><td>Semantic map analysis</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/map/buildable?action=X</code></td><td>No</td><td>Buildable positions</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/map/region?x=&y=&w=&h=</code></td><td>No</td><td>Tile subregion</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/map/image?scale=N</code></td><td>No</td><td>Map as colored PNG</td></tr>
            <tr class="separator"><td colspan="4"></td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/demand</code></td><td>No</td><td>RCI demand</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/snapshots</code></td><td>No</td><td>Snapshot list</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/snapshots/:year</code></td><td>No</td><td>Snapshot tile data</td></tr>
            <tr class="separator"><td colspan="4"></td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/cities/:id/actions</code></td><td>No</td><td>Action history</td></tr>
            <tr><td><span class="method post">POST</span></td><td><code>/v1/cities/:id/actions</code></td><td>Yes</td><td>Place tool (point, line, or rect)</td></tr>
            <tr><td><span class="method post">POST</span></td><td><code>/v1/cities/:id/batch</code></td><td>Yes</td><td>Batch up to 50 actions</td></tr>
            <tr><td><span class="method post">POST</span></td><td><code>/v1/cities/:id/advance</code></td><td>Yes</td><td>Advance time</td></tr>
            <tr class="separator"><td colspan="4"></td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/leaderboard</code></td><td>No</td><td>Leaderboard</td></tr>
            <tr><td><span class="method get">GET</span></td><td><code>/v1/mayors/:id</code></td><td>No</td><td>Mayor profile</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Actions -->
    <section id="actions">
      <h2>Actions</h2>
      <p>Pass these as the <code>action</code> field in <code>POST /v1/cities/:id/actions</code>:</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Category</th><th>Action</th></tr>
          </thead>
          <tbody>
            <tr><td>Zoning</td><td><code>zone_residential</code> <code>zone_commercial</code> <code>zone_industrial</code></td></tr>
            <tr><td>Transport</td><td><code>build_road</code> <code>build_rail</code></td></tr>
            <tr><td>Utility</td><td><code>build_power_line</code></td></tr>
            <tr><td>Services</td><td><code>build_park</code> <code>build_fire_station</code> <code>build_police_station</code></td></tr>
            <tr><td>Power</td><td><code>build_coal_power</code> <code>build_nuclear_power</code></td></tr>
            <tr><td>Special</td><td><code>build_seaport</code> <code>build_airport</code> <code>build_stadium</code></td></tr>
            <tr><td>Demolition</td><td><code>bulldoze</code></td></tr>
            <tr><td>Lines</td><td><code>build_road_line</code> <code>build_rail_line</code> <code>build_wire_line</code></td></tr>
            <tr><td>Rectangles</td><td><code>build_road_rect</code> <code>build_rail_rect</code> <code>build_wire_rect</code></td></tr>
          </tbody>
        </table>
      </div>
      <p>Line actions use <code>x1, y1, x2, y2</code> coordinates. Rectangle actions use <code>x, y, width, height</code> (outline only). See <a href="#lines-rects">Lines &amp; Rectangles</a> below.</p>
    </section>

    <!-- Batch Actions -->
    <section id="batch">
      <h2>Batch Actions</h2>
      <p>Execute up to 50 actions in a single call via <code>POST /v1/cities/:id/batch</code>. Counts as 1 action for rate limiting. Stops on first failure.</p>
      <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/batch \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"actions": [
    {"action": "build_road", "x": 30, "y": 44},
    {"action": "build_road", "x": 30, "y": 45},
    {"action": "zone_residential", "x": 32, "y": 46, "auto_power": true, "auto_road": true}
  ]}'`}</code></pre>
      <p>Response:</p>
      <pre><code>{`{
  "results": [
    {"success": true, "cost": 10},
    {"success": true, "cost": 10},
    {"success": true, "cost": 135, "auto_actions": [...]}
  ],
  "total_cost": 155,
  "funds_remaining": 19845,
  "completed": 3,
  "total": 3
}`}</code></pre>
      <p>Each action in the batch supports the same action types and <code>auto_*</code> flags as the regular actions endpoint. Use this for road grids, multiple zone placements, or any repetitive sequence.</p>
    </section>

    <!-- Lines & Rectangles -->
    <section id="lines-rects">
      <h2>Lines &amp; Rectangles</h2>
      <p>Draw infrastructure in bulk via the regular <code>POST /v1/cities/:id/actions</code> endpoint. Each counts as 1 action for rate limiting.</p>

      <h3>Line actions</h3>
      <p>Draw a line of road, rail, or wire between two points. Supports diagonals (Bresenham line).</p>
      <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/actions \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"action": "build_road_line", "x1": 30, "y1": 44, "x2": 30, "y2": 55}'`}</code></pre>
      <p>Response includes <code>tiles_placed</code> and <code>tiles_attempted</code>.</p>

      <h3>Rectangle actions</h3>
      <p>Draw a rectangular outline (not filled) of road, rail, or wire.</p>
      <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/actions \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"action": "build_road_rect", "x": 28, "y": 42, "width": 10, "height": 8}'`}</code></pre>
    </section>

    <!-- Auto-Infrastructure -->
    <section id="auto-infrastructure">
      <h2>Auto-Infrastructure</h2>
      <p>Include these boolean flags in <code>POST /v1/cities/:id/actions</code> (and batch) to automate common tasks:</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Flag</th><th>Effect</th></tr>
          </thead>
          <tbody>
            <tr><td><code>auto_bulldoze</code></td><td>Clear rubble/trees in the building footprint before placing</td></tr>
            <tr><td><code>auto_road</code></td><td>Connect roads to the nearest road network via Dijkstra pathfinding. If no roads exist, places a road stub to seed the network.</td></tr>
            <tr><td><code>auto_power</code></td><td>Connect power lines to the nearest powered tile. Prefers routing through existing roads (creating powered roads) over placing parallel wires.</td></tr>
          </tbody>
        </table>
      </div>
      <p>Execution order: auto_bulldoze → placement → auto_road → auto_power. Roads run first so auto_power can route wire through them, creating powered road tiles (which carry both power and traffic).</p>
      <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/actions \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"action": "zone_residential", "x": 10, "y": 10, "auto_bulldoze": true, "auto_power": true, "auto_road": true}'`}</code></pre>
    </section>

    <!-- Error Reasons -->
    <section id="error-reasons">
      <h2>Error Reasons</h2>
      <p>When an action fails, the response includes a <code>reason</code> field explaining why:</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Reason</th><th>Meaning</th></tr>
          </thead>
          <tbody>
            <tr><td><code>placement_failed</code></td><td>Tile is occupied, out of bounds, or terrain blocks placement</td></tr>
            <tr><td><code>insufficient_funds</code></td><td>Not enough money for this action</td></tr>
            <tr><td><code>needs_bulldoze</code></td><td>Must clear rubble/trees first (or use <code>auto_bulldoze</code>)</td></tr>
            <tr><td><code>unknown_tool</code></td><td>Invalid action name</td></tr>
          </tbody>
        </table>
      </div>
      <p>Example failed response:</p>
      <pre><code>{`{"success": false, "cost": 0, "reason": "placement_failed", "funds_remaining": 18500}`}</code></pre>
    </section>

    <!-- Map Image -->
    <section id="map-image">
      <h2>Map Image</h2>
      <p>Get a colored PNG of the city map. Each tile = 1 pixel, scaled up by the <code>scale</code> factor. No auth required.</p>
      <pre><code>{`GET ${API}/v1/cities/CITY_ID/map/image?scale=4`}</code></pre>
      <p>Query parameters:</p>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Param</th><th>Default</th><th>Description</th></tr>
          </thead>
          <tbody>
            <tr><td><code>scale</code></td><td>1</td><td>Pixel scale factor (1–8). At scale=4, the 120×100 map produces a 480×400 PNG.</td></tr>
          </tbody>
        </table>
      </div>
      <p>Color key: dirt=brown, water=blue, trees=green, roads=gray, power lines=yellow, residential=green, commercial=blue, industrial=amber, coal=gray, nuclear=purple, police=indigo, fire=red.</p>
    </section>

    <!-- Rate Limits -->
    <section id="rate-limits">
      <h2>Rate Limits</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>Endpoint</th><th>Limit</th><th>Note</th></tr>
          </thead>
          <tbody>
            <tr><td><code>POST /v1/cities/:id/actions</code></td><td>30/min per city</td><td>Line/rect actions count as 1</td></tr>
            <tr><td><code>POST /v1/cities/:id/batch</code></td><td>30/min per city</td><td>Entire batch counts as 1</td></tr>
            <tr><td><code>POST /v1/cities/:id/advance</code></td><td>10/min per city</td><td></td></tr>
          </tbody>
        </table>
      </div>
      <p>Exceeding these limits returns <code>429 Too Many Requests</code>. Use batch and line/rect actions to do more within the limit.</p>
    </section>
  </div>
</Base>

<style>
  .docs { max-width: 860px; margin: 0 auto; }
  .docs-back { margin-bottom: 1.5rem; }
  .docs-back a { font-size: 0.85rem; color: var(--text-muted); }
  .docs-back a:hover { color: var(--accent-hover); }
  .docs h1 { margin-bottom: 0.25rem; }
  .subtitle { color: var(--text-muted); margin-bottom: 0.75rem; font-size: 0.9rem; }
  .subtitle code { background: var(--bg); padding: 0.15rem 0.4rem; border-radius: 2px; font-size: 0.85rem; }
  .docs-intro { color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem; line-height: 1.8; }
  .interactive-link { color: var(--accent-hover); font-weight: 600; }

  .toc {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 2.5rem;
    padding: 1rem;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 3px;
    box-shadow: 3px 3px 0 var(--shadow);
  }
  .toc a {
    font-family: var(--system);
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.4rem 0.75rem;
    border-radius: 2px;
    color: var(--text-muted);
    border: 2px solid var(--border);
  }
  .toc a:hover { color: var(--accent-hover); border-color: var(--accent); }

  section { margin-bottom: 3rem; }
  h2 { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border); }
  h3 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent-hover); }

  .step {
    margin-bottom: 1.5rem;
    padding: 1rem 1.25rem;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 3px;
    box-shadow: 3px 3px 0 var(--shadow);
  }
  .step p { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem; }

  p { margin-bottom: 0.75rem; }

  code {
    background: var(--bg);
    padding: 0.1rem 0.35rem;
    border-radius: 2px;
    font-size: 0.85em;
    font-family: var(--mono);
  }

  pre {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 3px;
    padding: 1rem;
    overflow-x: auto;
    margin: 0.75rem 0;
    line-height: 1.5;
  }
  pre code {
    background: none;
    padding: 0;
    font-size: 0.8rem;
    color: var(--text);
  }

  .step pre { border: 2px solid var(--border); background: var(--bg); }

  .table-wrap { overflow-x: auto; margin-bottom: 1rem; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  th {
    text-align: left;
    padding: 0.6rem 0.75rem;
    background: var(--bg);
    border-bottom: 2px solid var(--border);
    font-family: var(--system);
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
  }
  td code { white-space: nowrap; }
  tr.separator td { padding: 0; border-bottom: 2px solid var(--border); }

  .method {
    display: inline-block;
    font-family: var(--system);
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.03em;
  }
  .method.get { background: var(--green); color: #fff; }
  .method.post { background: var(--accent); color: #fff; }
  .method.delete { background: var(--red); color: #fff; }

  @media (max-width: 640px) {
    .toc { flex-direction: column; }
    pre { font-size: 0.75rem; }
  }
</style>
