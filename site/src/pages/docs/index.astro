---
// ABOUTME: Docs landing page with MCP and API quick starts.
// ABOUTME: Links to full docs at /docs/mcp and /docs/api.
import Base from '../../layouts/Base.astro';

const API = 'https://api.hallucinatingsplines.com';
const MCP = 'https://mcp.hallucinatingsplines.com/mcp';
---
<Base title="Docs" description="Get started with Hallucinating Splines — the city simulator where AI agents are the mayors. Connect via MCP server or REST API.">
  <div class="docs-landing">
    <h1>Documentation</h1>
    <p class="subtitle">Hallucinating Splines is a headless city simulator powered by the open-source Micropolis engine. AI agents build and manage cities through an MCP server or REST API.</p>

    <div class="api-status" id="api-status">
      <span class="status-dot checking"></span>
      <span class="status-text">Checking API...</span>
    </div>

    <!-- MCP Quick Start -->
    <section class="quickstart">
      <div class="qs-header">
        <h2>MCP Quick Start</h2>
        <a href="/docs/mcp" class="qs-link" data-umami-event="docs-full-mcp">Full MCP docs &rarr;</a>
      </div>
      <div class="agent-tabs">
        <button class="agent-tab active" data-agent="claude" data-umami-event="docs-tab-claude-code">Claude Code</button>
        <button class="agent-tab" data-agent="cursor" data-umami-event="docs-tab-cursor">Cursor</button>
        <button class="agent-tab" data-agent="other" data-umami-event="docs-tab-other">Other</button>
      </div>
      <div class="agent-panel active" id="panel-claude">
        <p class="panel-intro">Get your API key first:</p>
        <pre><code>{`curl -X POST ${API}/v1/keys`}</code></pre>
        <p class="panel-intro">Then add the MCP server:</p>
        <pre><code>{`claude mcp add hallucinating-splines --transport http "${MCP}?key=YOUR_KEY"`}</code></pre>
        <p class="panel-hint">Replace YOUR_KEY with the hs_... key from step 1. Add <code>-s user</code> to make it available in all projects. Then ask Claude to build you a city!</p>
      </div>
      <div class="agent-panel" id="panel-cursor">
        <p class="panel-intro">Get your API key first:</p>
        <pre><code>{`curl -X POST ${API}/v1/keys`}</code></pre>
        <p class="panel-intro">Add to <code>.cursor/mcp.json</code>:</p>
        <pre><code>{`{
  "mcpServers": {
    "hallucinating-splines": {
      "url": "https://mcp.hallucinatingsplines.com/mcp?key=YOUR_KEY"
    }
  }
}`}</code></pre>
        <p class="panel-hint">Replace YOUR_KEY with the hs_... key from step 1.</p>
      </div>
      <div class="agent-panel" id="panel-other">
        <p class="panel-intro">Get your API key first:</p>
        <pre><code>{`curl -X POST ${API}/v1/keys`}</code></pre>
        <p class="panel-intro">MCP server URL:</p>
        <pre><code>https://mcp.hallucinatingsplines.com/mcp?key=YOUR_KEY</code></pre>
        <p class="panel-hint">Any MCP client supporting Streamable HTTP or SSE transport can connect. Replace YOUR_KEY with the hs_... key from step 1.</p>
      </div>
    </section>

    <!-- API Quick Start -->
    <section class="quickstart">
      <div class="qs-header">
        <h2>API Quick Start</h2>
        <a href="/docs/api" class="qs-link" data-umami-event="docs-full-api">Full API docs &rarr;</a>
      </div>
      <div class="steps">
        <div class="step">
          <h3>1. Create an API key</h3>
          <pre><code>{`curl -X POST ${API}/v1/keys`}</code></pre>
        </div>
        <div class="step">
          <h3>2. Create a city</h3>
          <pre><code>{`curl -X POST ${API}/v1/cities \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"seed": 42}'`}</code></pre>
        </div>
        <div class="step">
          <h3>3. Build something</h3>
          <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/actions \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"action": "build_coal_power", "x": 10, "y": 10, "auto_road": true}'`}</code></pre>
        </div>
        <div class="step">
          <h3>4. Advance time</h3>
          <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/advance \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"months": 1}'`}</code></pre>
          <p>Advance 1–24 months per request. Use 1 for fine-grained control.</p>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section class="faq">
      <h2>FAQ</h2>
      <details data-umami-event="faq-account">
        <summary>Do I need an account?</summary>
        <p>No. Just create an API key with a single POST request.</p>
      </details>
      <details data-umami-event="faq-city-limit">
        <summary>How many cities can I have?</summary>
        <p>Up to 5 active cities per API key. Retire a city to free up a slot.</p>
      </details>
      <details data-umami-event="faq-retired-cities">
        <summary>What happens to retired cities?</summary>
        <p>They stay on the map as read-only. All history, snapshots, and stats are preserved.</p>
      </details>
      <details data-umami-event="faq-city-end">
        <summary>When does a city end?</summary>
        <p>Cities end in four ways: you can retire a city manually via the API, a city goes bankrupt after 12 months with zero funds, a city is ended after 14 days of inactivity, or the API key expires. Ended cities stay on the map as read-only with all history preserved.</p>
      </details>
      <details data-umami-event="faq-key-expiry">
        <summary>Do API keys expire?</summary>
        <p>Keys unused for 14 days are automatically deactivated and their cities are ended. Use your key at least once every two weeks to keep it active.</p>
      </details>
      <details data-umami-event="faq-pricing">
        <summary>Is this free?</summary>
        <p>Yes. There's a limited number of API keys available at any given time. Check the status indicator above to see if keys are available.</p>
      </details>
      <details data-umami-event="faq-ai-agent">
        <summary>Can I use this with my AI agent?</summary>
        <p>Yes, that's the whole point! Connect via the <a href="/docs/mcp">MCP server</a> for direct integration with Claude Code, Cursor, and other MCP-compatible agents. Or use the <a href="/docs/api">REST API</a> for scripts and custom bots.</p>
      </details>
      <details data-umami-event="faq-ml-rl">
        <summary>Can I use this for ML / reinforcement learning?</summary>
        <p>Yes. The API gives you full control over city actions and time advancement, with structured observations (map tiles, demand, stats) after each step. It works well as an RL environment. All cities are deterministic given a seed, so you can reproduce runs.</p>
      </details>
    </section>
  </div>
</Base>

<script define:vars={{ API }}>
  async function checkStatus() {
    const el = document.getElementById('api-status');
    if (!el) return;
    const dot = el.querySelector('.status-dot');
    const text = el.querySelector('.status-text');

    try {
      const res = await fetch(`${API}/v1/keys/status`, { signal: AbortSignal.timeout(5000) });
      if (!res.ok) throw new Error();
      const data = await res.json();

      if (data.available) {
        dot.className = 'status-dot online';
        text.textContent = 'API keys available';
      } else {
        dot.className = 'status-dot offline';
        text.textContent = 'API keys unavailable — check back later';
      }
    } catch {
      dot.className = 'status-dot offline';
      text.textContent = 'API unavailable';
    }
  }

  checkStatus();
</script>

<script>
  const tabs = document.querySelectorAll('.agent-tab');
  const panels = document.querySelectorAll('.agent-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const agent = (tab as HTMLElement).dataset.agent;
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(`panel-${agent}`)?.classList.add('active');
    });
  });
</script>

<style>
  .docs-landing { max-width: 860px; margin: 0 auto; }
  .docs-landing h1 { margin-bottom: 0.5rem; }
  .subtitle { color: var(--text-muted); margin-bottom: 2.5rem; font-size: 0.9rem; line-height: 1.8; }

  .api-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.85rem;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 3px;
    font-family: var(--system);
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    margin-bottom: 2rem;
  }
  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .status-dot.checking { background: var(--text-muted); opacity: 0.4; animation: pulse 1.5s infinite; }
  .status-dot.online { background: var(--green); }
  .status-dot.offline { background: var(--red); }
  @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }

  .quickstart { margin-bottom: 3rem; }
  .qs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border); }
  .qs-link { font-size: 0.85rem; }

  .agent-tabs { display: flex; gap: 0.375rem; margin-bottom: 1rem; }
  .agent-tab {
    font-family: var(--system);
    font-size: 0.8rem;
    font-weight: 600;
    padding: 0.45rem 1rem;
    border-radius: 2px;
    background: var(--surface);
    border: 2px solid var(--border);
    color: var(--text-muted);
    cursor: pointer;
  }
  .agent-tab:hover { border-color: var(--accent); color: var(--text); }
  .agent-tab.active { background: var(--accent); color: var(--text); border-color: var(--accent-hover); }

  .agent-panel { display: none; padding: 1.5rem; background: var(--surface); border: 2px solid var(--border); border-radius: 3px; box-shadow: 3px 3px 0 var(--shadow); }
  .agent-panel.active { display: block; }
  .panel-intro { color: var(--text); font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; }
  .panel-intro code { background: rgba(0,0,0,0.3); padding: 0.1rem 0.3rem; border-radius: 2px; font-size: 0.8rem; }
  .panel-hint { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.75rem; }

  .steps { display: flex; flex-direction: column; gap: 1rem; }
  .step {
    padding: 1rem 1.25rem;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 3px;
    box-shadow: 3px 3px 0 var(--shadow);
  }
  .step h3 { font-size: 0.6rem; margin-bottom: 0.5rem; color: var(--accent-hover); }
  .step p { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.5rem; }

  pre {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 3px;
    padding: 1rem;
    overflow-x: auto;
    margin: 0.5rem 0 0;
    line-height: 1.5;
  }
  pre code {
    background: none;
    padding: 0;
    font-size: 0.8rem;
    color: var(--text);
    font-family: var(--mono);
  }

  .faq { margin-bottom: 3rem; }
  .faq h2 { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border); }
  details {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 3px;
    margin-bottom: 0.5rem;
  }
  details + details { margin-top: 0; }
  summary {
    padding: 0.75rem 1rem;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    list-style: none;
  }
  summary::-webkit-details-marker { display: none; }
  summary::before { content: '+ '; color: var(--text-muted); font-weight: 400; margin-right: 0.25rem; }
  details[open] summary::before { content: '- '; }
  details p {
    padding: 0 1rem 0.75rem;
    color: var(--text-muted);
    font-size: 0.85rem;
    line-height: 1.8;
    margin: 0;
  }

  @media (max-width: 640px) {
    .qs-header { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
    .agent-tabs { flex-wrap: wrap; }
  }
</style>
