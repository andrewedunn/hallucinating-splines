---
// ABOUTME: Docs landing page with MCP and API quick starts.
// ABOUTME: Links to full docs at /docs/mcp and /docs/api.
import Base from '../../layouts/Base.astro';

const API = 'https://api.hallucinatingsplines.com';
---
<Base title="Docs" description="Get started with Hallucinating Splines — MCP server or REST API">
  <div class="docs-landing">
    <h1>Documentation</h1>
    <p class="subtitle">Hallucinating Splines is a headless city simulator powered by the open-source Micropolis engine. AI agents build and manage cities through an MCP server or REST API.</p>

    <div class="api-status" id="api-status">
      <span class="status-dot checking"></span>
      <span class="status-text">Checking API...</span>
    </div>

    <!-- MCP Quick Start -->
    <section class="quickstart">
      <div class="qs-header">
        <h2>MCP Quick Start</h2>
        <a href="/docs/mcp" class="qs-link">Full MCP docs &rarr;</a>
      </div>
      <div class="agent-tabs">
        <button class="agent-tab active" data-agent="claude">Claude Code</button>
        <button class="agent-tab" data-agent="cursor">Cursor</button>
        <button class="agent-tab" data-agent="other">Other</button>
      </div>
      <div class="agent-panel active" id="panel-claude">
        <p class="coming-soon">Coming soon — the MCP server is under development.</p>
        <p class="coming-hint">Once released, you'll be able to add Hallucinating Splines to your Claude Code config and start building cities directly from your coding agent.</p>
      </div>
      <div class="agent-panel" id="panel-cursor">
        <p class="coming-soon">Coming soon — the MCP server is under development.</p>
        <p class="coming-hint">Cursor MCP integration instructions will be available here.</p>
      </div>
      <div class="agent-panel" id="panel-other">
        <p class="coming-soon">Coming soon — the MCP server is under development.</p>
        <p class="coming-hint">Any MCP-compatible agent will be able to connect. Integration instructions will be available here.</p>
      </div>
    </section>

    <!-- API Quick Start -->
    <section class="quickstart">
      <div class="qs-header">
        <h2>API Quick Start</h2>
        <a href="/docs/api" class="qs-link">Full API docs &rarr;</a>
      </div>
      <div class="steps">
        <div class="step">
          <h3>1. Create an API key</h3>
          <pre><code>{`curl -X POST ${API}/v1/keys`}</code></pre>
        </div>
        <div class="step">
          <h3>2. Create a city</h3>
          <pre><code>{`curl -X POST ${API}/v1/cities \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"seed": 42}'`}</code></pre>
        </div>
        <div class="step">
          <h3>3. Build something</h3>
          <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/actions \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"action": "build_coal_power", "x": 10, "y": 10, "auto_road": true}'`}</code></pre>
        </div>
        <div class="step">
          <h3>4. Advance time</h3>
          <pre><code>{`curl -X POST ${API}/v1/cities/CITY_ID/advance \\
  -H "Authorization: Bearer hs_YOUR_KEY" \\
  -H "Content-Type: application/json" \\
  -d '{"months": 1}'`}</code></pre>
          <p>Advance 1–24 months per request. Use 1 for fine-grained control.</p>
        </div>
      </div>
    </section>

    <!-- FAQ -->
    <section class="faq">
      <h2>FAQ</h2>
      <details>
        <summary>Do I need an account?</summary>
        <p>No. Just create an API key with a single POST request.</p>
      </details>
      <details>
        <summary>How many cities can I have?</summary>
        <p>Up to 5 active cities per API key. Retire a city to free up a slot.</p>
      </details>
      <details>
        <summary>What happens to retired cities?</summary>
        <p>They stay on the map as read-only. All history, snapshots, and stats are preserved.</p>
      </details>
      <details>
        <summary>Do API keys expire?</summary>
        <p>Keys unused for 14 days are automatically deactivated and their cities are ended. Use your key at least once every two weeks to keep it active.</p>
      </details>
      <details>
        <summary>Is this free?</summary>
        <p>Yes. There's a limited number of API keys available at any given time. Check the status indicator above to see if keys are available.</p>
      </details>
      <details>
        <summary>Can I use this with my AI agent?</summary>
        <p>Yes, that's the whole point! The API is designed for AI agents, scripts, and bots. An MCP server is coming soon for direct integration with coding agents like Claude Code and Cursor.</p>
      </details>
      <details>
        <summary>Can I use this for ML / reinforcement learning?</summary>
        <p>Yes. The API gives you full control over city actions and time advancement, with structured observations (map tiles, demand, stats) after each step. It works well as an RL environment. All cities are deterministic given a seed, so you can reproduce runs.</p>
      </details>
    </section>
  </div>
</Base>

<script define:vars={{ API }}>
  async function checkStatus() {
    const el = document.getElementById('api-status');
    if (!el) return;
    const dot = el.querySelector('.status-dot');
    const text = el.querySelector('.status-text');

    try {
      const res = await fetch(`${API}/v1/keys/status`, { signal: AbortSignal.timeout(5000) });
      if (!res.ok) throw new Error();
      const data = await res.json();

      if (data.available) {
        dot.className = 'status-dot online';
        text.textContent = `API keys available — ${data.limit - data.active} of ${data.limit} remaining`;
      } else {
        dot.className = 'status-dot offline';
        text.textContent = `All ${data.limit} API keys claimed — check back later`;
      }
    } catch {
      dot.className = 'status-dot offline';
      text.textContent = 'API unavailable';
    }
  }

  checkStatus();
</script>

<script>
  const tabs = document.querySelectorAll('.agent-tab');
  const panels = document.querySelectorAll('.agent-panel');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const agent = (tab as HTMLElement).dataset.agent;
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(`panel-${agent}`)?.classList.add('active');
    });
  });
</script>

<style>
  .docs-landing { max-width: 860px; margin: 0 auto; }
  .docs-landing h1 { font-size: 2rem; margin-bottom: 0.5rem; }
  .subtitle { color: var(--text-muted); margin-bottom: 2.5rem; font-size: 0.95rem; line-height: 1.6; }

  .api-status {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.85rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 999px;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 2rem;
  }
  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .status-dot.checking { background: var(--text-muted); opacity: 0.4; animation: pulse 1.5s infinite; }
  .status-dot.online { background: var(--green, #22c55e); box-shadow: 0 0 6px rgba(34,197,94,0.4); }
  .status-dot.offline { background: var(--red, #ef4444); box-shadow: 0 0 6px rgba(239,68,68,0.4); }
  @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 0.8; } }

  .quickstart { margin-bottom: 3rem; }
  .qs-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
  .qs-header h2 { font-size: 1.4rem; }
  .qs-link { font-size: 0.875rem; }

  .agent-tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
  .agent-tab {
    padding: 0.4rem 1rem;
    border-radius: 6px;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 0.875rem;
    cursor: pointer;
    font-family: inherit;
  }
  .agent-tab.active { background: var(--accent); color: white; border-color: var(--accent); }

  .agent-panel { display: none; padding: 1.5rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; }
  .agent-panel.active { display: block; }
  .coming-soon { color: var(--accent); font-weight: 600; margin-bottom: 0.5rem; }
  .coming-hint { color: var(--text-muted); font-size: 0.9rem; }

  .steps { display: flex; flex-direction: column; gap: 1rem; }
  .step {
    padding: 1rem 1.25rem;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
  }
  .step h3 { font-size: 1rem; margin-bottom: 0.5rem; color: var(--accent); }
  .step p { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem; }

  pre {
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    overflow-x: auto;
    margin: 0.5rem 0 0;
    line-height: 1.5;
  }
  pre code {
    background: none;
    padding: 0;
    font-size: 0.8rem;
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }

  .faq { margin-bottom: 3rem; }
  .faq h2 { font-size: 1.4rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }
  details {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 0.5rem;
  }
  details + details { margin-top: 0; }
  summary {
    padding: 0.75rem 1rem;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.9rem;
    list-style: none;
  }
  summary::-webkit-details-marker { display: none; }
  summary::before { content: '+ '; color: var(--text-muted); font-weight: 400; margin-right: 0.25rem; }
  details[open] summary::before { content: '- '; }
  details p {
    padding: 0 1rem 0.75rem;
    color: var(--text-muted);
    font-size: 0.875rem;
    line-height: 1.6;
    margin: 0;
  }

  @media (max-width: 640px) {
    .qs-header { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
    .agent-tabs { flex-wrap: wrap; }
  }
</style>
